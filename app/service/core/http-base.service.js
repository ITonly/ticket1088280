var _ = require("lodash");
var http_1 = require("@angular/http");
var Observable_1 = require("rxjs/Observable");
var GPXSRFStrategy = (function (_super) {
    __extends(GPXSRFStrategy, _super);
    function GPXSRFStrategy() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    GPXSRFStrategy.prototype.configureRequest = function (_req) {
        // noop
        console.log('XSRFStrategy');
    };
    return GPXSRFStrategy;
}(http_1.XSRFStrategy));
exports.GPXSRFStrategy = GPXSRFStrategy;
var HttpBaseService = (function (_super) {
    __extends(HttpBaseService, _super);
    function HttpBaseService(backend, defaultOptions, _router, storageService, loaderService) {
        var _this = _super.call(this, backend, defaultOptions) || this;
        _this._router = _router;
        _this.storageService = storageService;
        _this.loaderService = loaderService;
        return _this;
    }
    HttpBaseService.prototype.request = function (url, options) {
        this.loaderService.show();
        return this.intercept(_super.prototype.request.call(this, url, this.getRequestOptionArgs(options, url)).share());
    };
    HttpBaseService.prototype.get = function (url, options) {
        this.loaderService.show();
        return this.intercept(_super.prototype.get.call(this, url, options).share());
    };
    HttpBaseService.prototype.post = function (url, body, options) {
        this.loaderService.show();
        return this.intercept(_super.prototype.post.call(this, url, body, this.getRequestOptionArgs(options)).share());
    };
    HttpBaseService.prototype.put = function (url, body, options) {
        this.loaderService.show();
        return this.intercept(_super.prototype.put.call(this, url, body, this.getRequestOptionArgs(options)).share());
    };
    HttpBaseService.prototype.delete = function (url, options) {
        this.loaderService.show();
        return this.intercept(_super.prototype.delete.call(this, url, options).share());
    };
    HttpBaseService.prototype.getRequestOptionArgs = function (options, url) {
        if (options == null) {
            options = new http_1.RequestOptions();
        }
        if (options.headers == null) {
            options.headers = new http_1.Headers();
        }
        // Set Accept Json for Firefox
        options.headers.set('Accept', 'application/json');
        if (_.endsWith(url, 'token')) {
            return options;
        }
        options.headers.set('Content-Type', 'application/json');
        var token = this.storageService.getToken();
        if (token && token.access_token && !_.endsWith(url, 'register')
            && !_.endsWith(url, 'forget_password')) {
            options.headers.set('Authorization', 'bearer ' + token.access_token);
            if (token.user && token.user.currentCompany && token.user.currentCompany.id) {
                options.headers.set('company_id', token.user.currentCompany.id);
            }
        }
        return options;
    };
    HttpBaseService.prototype.intercept = function (observable) {
        var _this = this;
        observable.subscribe(function (res) { return _this.loaderService.hide(); }, function (error) { return _this.loaderService.hide(); });
        return observable.catch(function (err, source) {
            _this.loaderService.hide();
            if (err.status === 401 && !_.endsWith(err.url, 'token')) {
                _this._router.navigate(['/login']);
                return Observable_1.Observable.empty();
            }
            else {
                return Observable_1.Observable.throw(err);
            }
        });
    };
    return HttpBaseService;
}(http_1.Http));
exports.HttpBaseService = HttpBaseService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJodHRwLWJhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSwwQkFBNEI7QUFFNUIsc0NBR3VCO0FBRXZCLDhDQUE2QztBQUs3QztJQUFvQyxrQ0FBWTtJQUFoRDs7SUFLQSxDQUFDO0lBSlUseUNBQWdCLEdBQXZCLFVBQXdCLElBQVM7UUFDN0IsT0FBTztRQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUNMLHFCQUFDO0FBQUQsQ0FBQyxBQUxELENBQW9DLG1CQUFZLEdBSy9DO0FBTFksd0NBQWM7QUFPM0I7SUFBcUMsbUNBQUk7SUFFckMseUJBQVksT0FBMEIsRUFBRSxjQUE4QixFQUMxRCxPQUFlLEVBQVUsY0FBOEIsRUFDdkQsYUFBNEI7UUFGeEMsWUFHSSxrQkFBTSxPQUFPLEVBQUUsY0FBYyxDQUFDLFNBQ2pDO1FBSFcsYUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUFVLG9CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUN2RCxtQkFBYSxHQUFiLGFBQWEsQ0FBZTs7SUFFeEMsQ0FBQztJQUVELGlDQUFPLEdBQVAsVUFBUSxHQUFXLEVBQUUsT0FBNEI7UUFDN0MsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBTSxPQUFPLFlBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLENBQUM7SUFFRCw2QkFBRyxHQUFILFVBQUksR0FBVyxFQUFFLE9BQTRCO1FBQ3pDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQU0sR0FBRyxZQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCw4QkFBSSxHQUFKLFVBQUssR0FBVyxFQUFFLElBQVksRUFBRSxPQUE0QjtRQUN4RCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFNLElBQUksWUFBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDN0YsQ0FBQztJQUVELDZCQUFHLEdBQUgsVUFBSSxHQUFXLEVBQUUsSUFBWSxFQUFFLE9BQTRCO1FBQ3ZELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQU0sR0FBRyxZQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM1RixDQUFDO0lBRUQsZ0NBQU0sR0FBTixVQUFPLEdBQVcsRUFBRSxPQUE0QjtRQUM1QyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFNLE1BQU0sWUFBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsOENBQW9CLEdBQXBCLFVBQXFCLE9BQTRCLEVBQUUsR0FBWTtRQUMzRCxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNsQixPQUFPLEdBQUcsSUFBSSxxQkFBYyxFQUFFLENBQUM7UUFDbkMsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxQixPQUFPLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUM7UUFDcEMsQ0FBQztRQUNELDhCQUE4QjtRQUM5QixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUNsRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUNuQixDQUFDO1FBQ0QsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDeEQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMzQyxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQztlQUN4RCxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxTQUFTLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3JFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDMUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3BFLENBQUM7UUFDTCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsbUNBQVMsR0FBVCxVQUFVLFVBQTJCO1FBQXJDLGlCQWVDO1FBZEcsVUFBVSxDQUFDLFNBQVMsQ0FDaEIsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxFQUF6QixDQUF5QixFQUNoQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLEVBQXpCLENBQXlCLENBQ3JDLENBQUM7UUFFRixNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUcsRUFBRSxNQUFNO1lBQ2hDLEtBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDMUIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxLQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLE1BQU0sQ0FBQyx1QkFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzlCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixNQUFNLENBQUMsdUJBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNMLHNCQUFDO0FBQUQsQ0FBQyxBQXpFRCxDQUFxQyxXQUFJLEdBeUV4QztBQXpFWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHtcbiAgICBIdHRwLCBSZXF1ZXN0T3B0aW9uc0FyZ3MsIFJlc3BvbnNlLCBSZXF1ZXN0T3B0aW9ucywgWFNSRlN0cmF0ZWd5LFxuICAgIENvbm5lY3Rpb25CYWNrZW5kLCBIZWFkZXJzXG59IGZyb20gJ0Bhbmd1bGFyL2h0dHAnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xuXG5pbXBvcnQgeyBTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IExvYWRlclNlcnZpY2UgfSBmcm9tICcuL2xvYWRlcic7XG5cbmV4cG9ydCBjbGFzcyBHUFhTUkZTdHJhdGVneSBleHRlbmRzIFhTUkZTdHJhdGVneSB7XG4gICAgcHVibGljIGNvbmZpZ3VyZVJlcXVlc3QoX3JlcTogYW55KSB7XG4gICAgICAgIC8vIG5vb3BcbiAgICAgICAgY29uc29sZS5sb2coJ1hTUkZTdHJhdGVneScpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIEh0dHBCYXNlU2VydmljZSBleHRlbmRzIEh0dHAge1xuXG4gICAgY29uc3RydWN0b3IoYmFja2VuZDogQ29ubmVjdGlvbkJhY2tlbmQsIGRlZmF1bHRPcHRpb25zOiBSZXF1ZXN0T3B0aW9ucyxcbiAgICAgICAgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXIsIHByaXZhdGUgc3RvcmFnZVNlcnZpY2U6IFN0b3JhZ2VTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvYWRlclNlcnZpY2U6IExvYWRlclNlcnZpY2UpIHtcbiAgICAgICAgc3VwZXIoYmFja2VuZCwgZGVmYXVsdE9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJlcXVlc3QodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc0FyZ3MpOiBPYnNlcnZhYmxlPFJlc3BvbnNlPiB7XG4gICAgICAgIHRoaXMubG9hZGVyU2VydmljZS5zaG93KCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludGVyY2VwdChzdXBlci5yZXF1ZXN0KHVybCwgdGhpcy5nZXRSZXF1ZXN0T3B0aW9uQXJncyhvcHRpb25zLCB1cmwpKS5zaGFyZSgpKTtcbiAgICB9XG5cbiAgICBnZXQodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc0FyZ3MpOiBPYnNlcnZhYmxlPFJlc3BvbnNlPiB7XG4gICAgICAgIHRoaXMubG9hZGVyU2VydmljZS5zaG93KCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludGVyY2VwdChzdXBlci5nZXQodXJsLCBvcHRpb25zKS5zaGFyZSgpKTtcbiAgICB9XG5cbiAgICBwb3N0KHVybDogc3RyaW5nLCBib2R5OiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc0FyZ3MpOiBPYnNlcnZhYmxlPFJlc3BvbnNlPiB7XG4gICAgICAgIHRoaXMubG9hZGVyU2VydmljZS5zaG93KCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludGVyY2VwdChzdXBlci5wb3N0KHVybCwgYm9keSwgdGhpcy5nZXRSZXF1ZXN0T3B0aW9uQXJncyhvcHRpb25zKSkuc2hhcmUoKSk7XG4gICAgfVxuXG4gICAgcHV0KHVybDogc3RyaW5nLCBib2R5OiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc0FyZ3MpOiBPYnNlcnZhYmxlPFJlc3BvbnNlPiB7XG4gICAgICAgIHRoaXMubG9hZGVyU2VydmljZS5zaG93KCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludGVyY2VwdChzdXBlci5wdXQodXJsLCBib2R5LCB0aGlzLmdldFJlcXVlc3RPcHRpb25BcmdzKG9wdGlvbnMpKS5zaGFyZSgpKTtcbiAgICB9XG5cbiAgICBkZWxldGUodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc0FyZ3MpOiBPYnNlcnZhYmxlPFJlc3BvbnNlPiB7XG4gICAgICAgIHRoaXMubG9hZGVyU2VydmljZS5zaG93KCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludGVyY2VwdChzdXBlci5kZWxldGUodXJsLCBvcHRpb25zKS5zaGFyZSgpKTtcbiAgICB9XG5cbiAgICBnZXRSZXF1ZXN0T3B0aW9uQXJncyhvcHRpb25zPzogUmVxdWVzdE9wdGlvbnNBcmdzLCB1cmw/OiBzdHJpbmcpOiBSZXF1ZXN0T3B0aW9uc0FyZ3Mge1xuICAgICAgICBpZiAob3B0aW9ucyA9PSBudWxsKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gbmV3IFJlcXVlc3RPcHRpb25zKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9wdGlvbnMuaGVhZGVycyA9PSBudWxsKSB7XG4gICAgICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFNldCBBY2NlcHQgSnNvbiBmb3IgRmlyZWZveFxuICAgICAgICBvcHRpb25zLmhlYWRlcnMuc2V0KCdBY2NlcHQnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICBpZiAoXy5lbmRzV2l0aCh1cmwsICd0b2tlbicpKSB7XG4gICAgICAgICAgICByZXR1cm4gb3B0aW9ucztcbiAgICAgICAgfVxuICAgICAgICBvcHRpb25zLmhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICBsZXQgdG9rZW4gPSB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldFRva2VuKCk7XG4gICAgICAgIGlmICh0b2tlbiAmJiB0b2tlbi5hY2Nlc3NfdG9rZW4gJiYgIV8uZW5kc1dpdGgodXJsLCAncmVnaXN0ZXInKVxuICAgICAgICAgICAgJiYgIV8uZW5kc1dpdGgodXJsLCAnZm9yZ2V0X3Bhc3N3b3JkJykpIHtcbiAgICAgICAgICAgIG9wdGlvbnMuaGVhZGVycy5zZXQoJ0F1dGhvcml6YXRpb24nLCAnYmVhcmVyICcgKyB0b2tlbi5hY2Nlc3NfdG9rZW4pO1xuICAgICAgICAgICAgaWYgKHRva2VuLnVzZXIgJiYgdG9rZW4udXNlci5jdXJyZW50Q29tcGFueSAmJiB0b2tlbi51c2VyLmN1cnJlbnRDb21wYW55LmlkKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5oZWFkZXJzLnNldCgnY29tcGFueV9pZCcsIHRva2VuLnVzZXIuY3VycmVudENvbXBhbnkuaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcHRpb25zO1xuICAgIH1cblxuICAgIGludGVyY2VwdChvYnNlcnZhYmxlOiBPYnNlcnZhYmxlPGFueT4pOiBPYnNlcnZhYmxlPFJlc3BvbnNlPiB7XG4gICAgICAgIG9ic2VydmFibGUuc3Vic2NyaWJlKFxuICAgICAgICAgICAgcmVzID0+IHRoaXMubG9hZGVyU2VydmljZS5oaWRlKCksXG4gICAgICAgICAgICBlcnJvciA9PiB0aGlzLmxvYWRlclNlcnZpY2UuaGlkZSgpXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIG9ic2VydmFibGUuY2F0Y2goKGVyciwgc291cmNlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvYWRlclNlcnZpY2UuaGlkZSgpO1xuICAgICAgICAgICAgaWYgKGVyci5zdGF0dXMgPT09IDQwMSAmJiAhXy5lbmRzV2l0aChlcnIudXJsLCAndG9rZW4nKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3JvdXRlci5uYXZpZ2F0ZShbJy9sb2dpbiddKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5lbXB0eSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=